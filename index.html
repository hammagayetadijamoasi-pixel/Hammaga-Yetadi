<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Yaxshi AI & Pro</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root{--primary:#7C4DFF;--accent:#00E5FF;--bg:#0b0b12;--card:#0f1116;--muted:#99a0b3}
body{margin:0;font-family:Inter,Segoe UI,Roboto,Arial;background:var(--bg);color:#fff;min-height:100vh}
.container{padding:18px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.brand{font-weight:800;font-size:18px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01));border-radius:14px;padding:14px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.04)}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;background:linear-gradient(90deg,var(--primary),#536DFE);color:#fff;border:none;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
.small{font-size:13px;color:var(--muted)}
.chat-box{height:300px;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:8px}
.msg{max-width:78%;padding:8px 12px;border-radius:12px}
.msg.bot{background:rgba(255,255,255,0.03);align-self:flex-start}
.msg.user{background:var(--primary);color:#000;align-self:flex-end}
.input-row{display:flex;gap:8px}
.input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff}
.nav{position:fixed;left:16px;right:16px;bottom:16px;background:rgba(10,10,14,0.95);display:flex;justify-content:space-around;padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,0.03)}
.nav .item{color:rgba(255,255,255,0.6);font-size:13px}
.nav .item.active{color:var(--accent)}
.ad{display:none;padding:10px;border-radius:10px;background:linear-gradient(90deg,rgba(0,229,255,0.04),rgba(124,77,255,0.04));border:1px solid rgba(255,255,255,0.03);margin-bottom:12px}
.hidden{display:none}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="brand">Yaxshi <span style="color:var(--accent)">AI</span></div>
        <div id="userBadge" class="small">User</div>
    </div>

    <div id="emailCard" class="card hidden">
        <h3>So'nggi qadam: Email tasdiqlang</h3>
        <p class="small">Linkni olish uchun email talab qilinadi. Email faqat adminga ko'rsatiladi.</p>
        <input id="emailInput" type="email" class="input" placeholder="name@example.com" />
        <div style="margin-top:8px">
            <button class="btn" onclick="submitEmail()">Tasdiqlash va Kirish</button>
        </div>
    </div>

    <div id="mainArea" class="hidden">
        <div id="adBanner" class="ad">
            <div id="adTitle" style="font-weight:700"></div>
            <div id="adText" class="small"></div>
        </div>

        <div class="card">
            <h3>Pro Panel</h3>
            <p class="small">Quyidagi tugma orqali Pro sahifaga o‚Äòting.</p>
            <div style="margin-top:10px">
                <button class="btn" onclick="openPro()">Pro Versiya ga Kirish</button>
            </div>
        </div>

        <div class="card hidden" id="chatCard">
            <h3>Yaxshi AI</h3>
            <div id="chatBox" class="chat-box">
                <div class="msg bot">üëã Salom! Savolingizni yozing.</div>
            </div>
            <div style="margin-top:8px" class="input-row">
                <input id="chatInput" class="input" placeholder="Savol yozing..." onkeypress="if(event.key==='Enter') sendMsg()"/>
                <button class="btn" onclick="sendMsg()">Jo'nat</button>
            </div>
        </div>

        <div class="card">
            <h3>Bilimlar Bazasi</h3>
            <div id="resourcesList"></div>
        </div>
    </div>
</div>

<div class="nav" id="navbar" style="display:none">
    <div class="item active" onclick="showTab('home', this)">Asosiy</div>
    <div class="item" onclick="showTab('ai', this)">AI Chat</div>
    <div class="item" onclick="showTab('kb', this)">Bilimlar</div>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const params = new URLSearchParams(window.location.search);
const e = params.get('e') || "0"; // email status
const uName = decodeURIComponent(params.get('n') || "User");
const userId = params.get('id') || "";
let PRO_LINK = decodeURIComponent(params.get('cl') || "");
let CHANNELS = [];
let RESOURCES = [];
try { CHANNELS = JSON.parse(decodeURIComponent(params.get('ch') || "[]")); } catch(e){ CHANNELS = [];}
try { RESOURCES = JSON.parse(decodeURIComponent(params.get('rs') || "[]")); } catch(e){ RESOURCES = [];}
const adTitle = decodeURIComponent(params.get('at') || "");
const adText = decodeURIComponent(params.get('ax') || "");
const adLink = decodeURIComponent(params.get('al') || "");

window.onload = () => {
    document.getElementById('userBadge').innerText = uName;
    // show email step if e == "0"
    if (e === "0") {
        document.getElementById('emailCard').classList.remove('hidden');
        document.getElementById('mainArea').classList.add('hidden');
        document.getElementById('navbar').style.display = 'none';
    } else {
        document.getElementById('emailCard').classList.add('hidden');
        document.getElementById('mainArea').classList.remove('hidden');
        document.getElementById('navbar').style.display = 'flex';
    }
    // Ad
    if (adTitle) {
        document.getElementById('adBanner').style.display = 'block';
        document.getElementById('adTitle').innerText = adTitle;
        document.getElementById('adText').innerText = adText;
        if (adLink) {
            document.getElementById('adBanner').onclick = () => tg.openTelegramLink(adLink);
        }
    }
    renderResources();
};

function submitEmail(){
    const v = document.getElementById('emailInput').value.trim();
    if (!v || v.indexOf('@') === -1) {
        tg.showPopup({message:"Iltimos to'g'ri email kiriting."});
        return;
    }
    // send to bot
    tg.sendData("email:" + v);
    tg.showPopup({message:"Email yuborildi. Admin tekshiradi."});
}

function openPro(){
    if (PRO_LINK && PRO_LINK.length>5) {
        // open link externally
        tg.openLink(PRO_LINK, {try_instant_view:false});
    } else {
        tg.showPopup({message:"Pro link mavjud emas."});
    }
}

function renderResources(){
    const box = document.getElementById('resourcesList');
    box.innerHTML = "";
    if (!RESOURCES || RESOURCES.length===0) {
        box.innerHTML = "<div class='small'>Ma'lumot yo'q.</div>";
        return;
    }
    let html = "";
    RESOURCES.forEach(r => {
        html += `<div style="margin-top:8px"><button class="btn ghost" onclick="getResource(${r.id})">${r.name}</button></div>`;
    });
    box.innerHTML = html;
}

function getResource(id){
    tg.sendData("get_resource:" + id);
}

function showTab(tab, el){
    document.querySelectorAll('.nav .item').forEach(x=>x.classList.remove('active'));
    el.classList.add('active');
    if (tab==='home'){
        document.getElementById('chatCard').classList.add('hidden');
    } else if (tab==='ai'){
        document.getElementById('chatCard').classList.remove('hidden');
    } else if (tab==='kb'){
        // nothing special
    }
}

async function sendMsg(){
    const txt = document.getElementById('chatInput').value.trim();
    if (!txt) return;
    addChatMsg(txt,'user');
    document.getElementById('chatInput').value = '';
    // small proxy: we call a public lightweight endpoint for demo (no guarantee).
    // Better approach: bot server should proxy AI requests. Here we show a simple fetch to a free API.
    try {
        const prompt = `Siz professional yordamchi. Savol: ${txt}`;
        // Using a small public endpoint as placeholder ‚Äî in production proxy via bot server.
        const url = 'https://text.pollinations.ai/' + encodeURIComponent(prompt) + '?model=openai';
        const resp = await fetch(url);
        if (!resp.ok) throw new Error("Tarmoq xatosi");
        const reply = await resp.text();
        addChatMsg(reply, 'bot');
    } catch (err) {
        addChatMsg("‚ö†Ô∏è AI bilan bog'lanishda xato. Iltimos keyinroq urinib ko'ring.", 'bot');
    }
}

function addChatMsg(txt, who){
    const box = document.getElementById('chatBox');
    const div = document.createElement('div');
    div.className = 'msg ' + (who==='user' ? 'user' : 'bot');
    div.innerHTML = txt;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
}
</script>
</body>
</html>
