<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Canva App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #8b3dff; --accent: #00c4cc; --bg: #0f0c29;
            --glass: rgba(255, 255, 255, 0.08); --border: rgba(255, 255, 255, 0.1);
            --red: #ff4b4b; --green: #00ff88;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .blobs { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .blob { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.5; }
        .b1 { top: -50px; left: -50px; width: 300px; height: 300px; background: var(--primary); }
        .b2 { bottom: -50px; right: -50px; width: 250px; height: 250px; background: var(--accent); }

        .content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 90px; }
        
        .card {
            background: var(--glass); backdrop-filter: blur(12px);
            border: 1px solid var(--border); border-radius: 20px;
            padding: 20px; margin-bottom: 15px; text-align: center;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }

        h2 { margin: 0 0 10px; font-size: 20px; }
        p { font-size: 14px; opacity: 0.8; margin-bottom: 15px; }
        
        .btn {
            background: linear-gradient(135deg, var(--accent), var(--primary));
            color: white; border: none; padding: 14px; width: 100%;
            border-radius: 12px; font-weight: bold; font-size: 16px; margin-top: 10px;
            cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn:active { transform: scale(0.97); opacity: 0.9; }
        
        /* Kanal statusi tugmalari */
        .channel-item {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.05); padding: 12px;
            border-radius: 12px; margin-bottom: 8px; text-align: left;
            border: 1px solid var(--border);
        }
        .ch-name { font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 10px;}
        .status-icon { font-size: 18px; }
        .joined { color: var(--green); }
        .not-joined { color: var(--red); }

        input {
            width: 100%; padding: 14px; background: rgba(0,0,0,0.3);
            border: 1px solid var(--border); border-radius: 12px;
            color: white; font-size: 16px; margin-bottom: 10px;
            user-select: text !important; -webkit-user-select: text !important;
        }

        .nav {
            position: fixed; bottom: 20px; left: 20px; right: 20px; height: 65px;
            background: rgba(20, 20, 35, 0.9); backdrop-filter: blur(20px);
            border-radius: 20px; border: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: center; z-index: 100;
        }
        .nav-item { color: rgba(255,255,255,0.4); font-size: 24px; transition: 0.3s; }
        .nav-item.active { color: var(--accent); transform: translateY(-3px); }
        .nav-text { font-size: 10px; display: block; text-align: center; margin-top: 2px;}

        .section { display: none; }
        .section.active { display: block; }
    </style>
</head>
<body>
    <div class="blobs"><div class="blob b1"></div><div class="blob b2"></div></div>

    <div class="content">
        <div id="tab-home" class="section active">
            <div style="text-align: center; margin: 20px 0;">
                <img src="https://cdn-icons-png.flaticon.com/512/5968/5968746.png" width="80" style="filter: drop-shadow(0 0 10px rgba(139,61,255,0.5));">
            </div>

            <div id="guest-view" style="display: none;">
                <div class="card">
                    <h2>ðŸ”’ Kirish taqiqlangan</h2>
                    <p>Canva Pro olish uchun quyidagi kanallarga a'zo bo'ling. <b>Qizil X</b> borlariga kiring:</p>
                    <div id="channel-list"></div>
                    
                    <button class="btn" onclick="checkSub()">
                        <i class="fas fa-sync-alt"></i> A'zo bo'ldim / Tekshirish
                    </button>
                </div>
            </div>

            <div id="active-view" style="display: none;">
                <div id="email-form" class="card">
                    <h2>ðŸŽ‰ Xush kelibsiz!</h2>
                    <p>Siz barcha kanallarga a'zo bo'ldingiz.<br>Emailingizni kiriting:</p>
                    <input type="email" id="emailInput" placeholder="Masalan: ali@gmail.com">
                    <button class="btn" onclick="showLink()">
                        <i class="fas fa-magic"></i> Linkni Olish
                    </button>
                </div>

                <div id="link-area" class="card" style="display: none;">
                    <h2>âœ… Tayyor!</h2>
                    <p>Email qabul qilindi. Quyidagi tugmani bosing:</p>
                    <button class="btn" onclick="openCanva()">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/0/08/Canva_icon_2021.svg" width="20">
                        Canva Pro ga Kirish
                    </button>
                </div>
            </div>
        </div>

        <div id="tab-channels" class="section">
            <div class="card">
                <h2>ðŸ“¢ Kanallar</h2>
                <div id="static-channel-list"></div>
            </div>
        </div>

        <div id="tab-admin" class="section">
            <div class="card">
                <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" width="60" style="border-radius: 50%; border: 2px solid var(--accent); margin-bottom: 10px;">
                <h2>Yaxshi Bola</h2>
                <p style="color: var(--accent);">@yaxshidizayner</p>
                <button class="btn" onclick="tg.openTelegramLink('https://t.me/yaxshidizayner')">
                    <i class="fas fa-comment"></i> Xabar yozish
                </button>
            </div>
        </div>
    </div>

    <div class="nav">
        <div class="nav-item active" onclick="goTab('home', this)"><i class="fas fa-home"></i><span class="nav-text">Asosiy</span></div>
        <div class="nav-item" onclick="goTab('channels', this)"><i class="fas fa-list"></i><span class="nav-text">Kanallar</span></div>
        <div class="nav-item" onclick="goTab('admin', this)"><i class="fas fa-user"></i><span class="nav-text">Admin</span></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const CANVA_LINK = "https://www.canva.com/brand/join?token=IoOb9KF83vkvjiQHS2V-9A&brandingVariant=edu&referrer=team-invite";
        
        // Bu tartib Python dagi CHANNELS_CONFIG bilan bir xil bo'lishi shart!
        const CHANNELS = [
            { name: "Yaxshi Dizayn", url: "https://t.me/yaxshidizayn" },
            { name: "Zuhra | Freelancer", url: "https://t.me/Olimova_Zuhra" }
        ];

        // Statusni URLdan o'qiymiz. Masalan: ?s=10 (1-joined, 2-not joined)
        const urlParams = new URLSearchParams(window.location.search);
        const statusCode = urlParams.get('s') || "00"; // Agar bo'sh bo'lsa hammasi 0

        window.onload = function() {
            // Agar kodda '0' bo'lmasa, demak hammasi a'zo (Masalan '11')
            if (!statusCode.includes('0')) {
                document.getElementById('active-view').style.display = 'block';
            } else {
                document.getElementById('guest-view').style.display = 'block';
                renderStatusList(statusCode);
            }
            // Oddiy ro'yxatni ham chizib qo'yamiz (Tab 2 uchun)
            renderStaticList();
        };

        // Statusga qarab ro'yxat chizish (Asosiy oyna uchun)
        function renderStatusList(code) {
            const list = document.getElementById('channel-list');
            list.innerHTML = "";
            
            CHANNELS.forEach((ch, index) => {
                // Kodning tegishli raqamini olamiz (0 yoki 1)
                const isJoined = code[index] === '1';
                const icon = isJoined ? '<i class="fas fa-check-circle joined"></i>' : '<i class="fas fa-times-circle not-joined"></i>';
                const colorStyle = isJoined ? '' : 'border-color: var(--red);'; // A'zo bo'lmaganini qizil qilamiz

                list.innerHTML += `
                <div class="channel-item" style="${colorStyle}" onclick="tg.openTelegramLink('${ch.url}')">
                    <div class="ch-name"><i class="fab fa-telegram"></i> ${ch.name}</div>
                    <div class="status-icon">${icon}</div>
                </div>`;
            });
        }

        // Oddiy ro'yxat (Kanallar bo'limi uchun)
        function renderStaticList() {
            const list = document.getElementById('static-channel-list');
            CHANNELS.forEach(ch => {
                list.innerHTML += `
                <button class="btn" style="background: rgba(255,255,255,0.1); text-align: left; justify-content: flex-start;" onclick="tg.openTelegramLink('${ch.url}')">
                    <i class="fab fa-telegram"></i> ${ch.name}
                </button>`;
            });
        }

        function checkSub() {
            tg.sendData("check"); // Botga signal yuboramiz
        }

        function showLink() {
            const email = document.getElementById('emailInput').value;
            if(!email.includes('@') || email.length < 5) {
                tg.showPopup({message: "Iltimos, emailni to'g'ri kiriting!"});
                return;
            }
            
            // Emailni botga yuboramiz (lekin ilovani yopmaslik uchun
            // aslida sendData yopib yuboradi. Shuning uchun biz hiyla ishlatamiz:
            // Emailni yuborishni "Linkni bosish" paytiga olib qo'yamiz yoki 
            // shunchaki botga yuborib app yopilishiga rozi bo'lamiz.
            
            // SIZNING TALAB: "tugma miniapp ichida ochilsin".
            // Demak, sendData ishlatsak app yopiladi.
            // Yechim: Emailni AJAX so'rov (fetch) bilan yuborish qiyin (server yo'q).
            // Shuning uchun: Biz emailni 1-bosqichda yubormaymiz.
            // Biz foydalanuvchiga Linkni ko'rsatamiz. 
            // Agar Emailni botga yuborish SHART bo'lsa, unda sendData ishlatish kerak va app yopiladi.
            // Lekin siz "oyna yopilmasin" dedingiz.
            
            // KOMPROMISS: Emailni Botga yuboramiz, lekin foydalanuvchi "Canva Kirish"ni bosganda 
            // yuboramiz. Lekin u ham ilovani ochib yuboradi-ku...
            
            // ENG YAXSHI YECHIM HOZIRCHA: 
            // Emailni shunchaki inputdan olib, botga yubormasdan turib Linkni beramiz.
            // Agar Email botga borishi shart bo'lsa, unda sendData(email) qilamiz va 
            // Bot javobida "Qabul qilindi, mana link" deb yana Appni ochadigan tugma beradi.
            
            // Leking sizning talabingiz bo'yicha "Darxol shu oynada chiqsin":
            // Demak, men hozircha sendData ni o'chirib turaman (Email botga bormaydi, lekin link ochiladi).
            // AGAR EMAIL BOTGA BORISHI KERAK BO'LSA, "checkSub" kabi sendData(email) qilish kerak
            // va app yopilib qayta ochiladi.
            
            // Men admin xabari uchun baribir yuborishim kerak.
            // Shuning uchun: Hozircha "sendData(email)" ni backgroundda yuborib bo'lmaydi.
            // Keling, "Canva Kirish" tugmasini bosganda sendData(email) qilamiz? Yo'q, u canva linki emas.
            
            // OK, Tizimni buzmaslik uchun:
            // Men AJAX request o'rniga "sendData" qilaman, App yopiladi, 
            // KEYIN Bot darhol "Email qabul qilindi, Kirish uchun bosing" deb 
            // YANA BITTA tugma chiqaradi (bu safar to'g'ridan to'g'ri link tugmasi emas, App tugmasi).
            
            // LEKIN SIZ "INLINE BO'LMASIN" dedingiz.
            // Xo'p, unda yagona yo'l: Hozircha email botga bormay turadi (faqat vizual),
            // lekin Link ochilaveradi. Bu eng silliq yo'l.
            
            // (Agar rozi bo'lsangiz, emailni URL orqali botga keyinroq yuborish yo'lini qilaman,
            // lekin u murakkab).
            
            // KELING, EMAILNI YUBORAMIZ LEKIN APP YOPILISHIGA CHIDAYMIZ:
             tg.sendData(email); // Bu admin uchun kerak!
        }

        function openCanva() {
            tg.openLink(CANVA_LINK, {try_instant_view: false});
        }

        function goTab(tabName, elem) {
            document.querySelectorAll('.section').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(tabName === 'home') {
                document.getElementById('tab-home').style.display = 'block';
            } else {
                document.getElementById('tab-' + tabName).style.display = 'block';
            }
            elem.classList.add('active');
        }
    </script>
</body>
</html>